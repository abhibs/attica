<?php session_start(); include("dbConnection.php"); header('Content-Type: application/json'); $branchId = $_GET['branchId'] ?? ''; if ($branchId === '') { echo json_encode(['success' => false, 'error' => 'Missing branchId']); exit; } $branchIdEsc = mysqli_real_escape_string($con, $branchId); /* * Fetch messages for a branch. Ordered oldest â†’ newest. * Time and date converted from UTC (stored) to IST for display. */ $sql = " SELECT c.id, c.sender_type, c.sender_id, c.message_type, c.message, c.image_file, DATE_FORMAT( CONVERT_TZ(c.created_at, '+00:00', '+05:30'), '%d-%m %H:%i' ) AS time, DATE_FORMAT( CONVERT_TZ(c.created_at, '+00:00', '+05:30'), '%d-%m-%Y' ) AS day, CASE WHEN c.sender_type = 'Branch' THEN CONCAT(COALESCE(b.branchName, c.sender_id), ' (', c.sender_id, ')') WHEN c.sender_type = 'Center' THEN CASE WHEN c.sender_id = 'atticamaster' THEN 'Attica Master' ELSE COALESCE(e.name, c.sender_id) END ELSE c.sender_id END AS sender_label FROM branch_chat c LEFT JOIN branch b ON c.sender_id = b.branchId LEFT JOIN employee e ON c.sender_id = e.empId WHERE c.branchId = '$branchIdEsc' ORDER BY c.id ASC LIMIT 200 "; $res = mysqli_query($con, $sql); $messages = []; while ($row = mysqli_fetch_assoc($res)) { $imageUrl = null; if (!empty($row['image_file'])) { $imageUrl = 'ChatImages/' . $row['image_file']; } $messages[] = [ 'id' => (int)$row['id'], 'sender_type' => $row['sender_type'], 'sender_id' => $row['sender_id'], 'sender_label' => $row['sender_label'], 'message_type' => $row['message_type'], 'message' => $row['message'], 'image_file' => $row['image_file'], 'image_url' => $imageUrl, 'time' => $row['time'], 'day' => $row['day'], ]; } echo json_encode([ 'success' => true, 'messages' => $messages ]);
